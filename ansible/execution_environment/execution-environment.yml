version: 3

images:
  base_image:
    name: registry.fedoraproject.org/fedora:42

dependencies:
  python_interpreter: # which python runtime to install
    package_system: python3 # install python3, required for Ansible to run, from a system package manager (e.g., dnf, apt)
  ansible_core: # how to install Ansible itself
    package_pip: ansible-core==2.17.1 # pin to the latest Ansible core for cache-race fixes
  ansible_runner:
    package_pip: ansible-runner==2.4.0 # upgraded for the latest executor fixes
  galaxy: requirements.yml # The content (e.g., docker_login, docker_image, etc) to bake into the execution environment image
  system: # linux system packages to install
    - openssh-clients # required for SSH connections to remote hosts.

additional_build_files:
  - src: files/website/
    dest: files/website/
    
additional_build_steps:
  # install the cloudflared client for sshing into the server via named host (e.g., ssh.dalhe.ai)
  prepend_final:
    - RUN dnf config-manager addrepo --from-repofile https://pkg.cloudflare.com/cloudflared-ascii.repo
    - RUN dnf install -y cloudflared
  append_final:
    - COPY _build/files/website /opt/website
